<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.mycompany.backend.dao.OrdersDao">

   <select id="selectByPage" resultType="order">
      select rnum
      		,order_id
      		,order_receiver
      		,order_tel
      		,order_address
      		,order_detail_address
      		,order_msg
      		,users_user_id
      		,order_state
      		,order_date
      		,order_zipcode
      		,order_account_name
      		,order_account
      		,order_total_price
      
      from (
          select rownum as rnum
	          	,order_id
	      		,order_receiver
	      		,order_tel
	      		,order_address
	      		,order_detail_address
	      		,order_msg
	      		,users_user_id
	      		,order_state
	      		,order_date
	      		,order_zipcode
	      		,order_account_name
	      		,order_account
	      		,order_total_price
     from (
             select order_id
		      		,order_receiver
		      		,order_tel
		      		,order_address
		      		,order_detail_address
		      		,order_msg
		      		,users_user_id
		      		,order_state
		      		,order_date
		      		,order_zipcode
		      		,order_account_name
		      		,order_account
		      		,order_total_price
             from orders
             
             <if test="state == 7">
             	where order_state != 0
             </if>
             <if test="state != 7">
             	where order_state = #{state}
             </if>
             
             <if test="search_user_id != 'undefined'">
             and users_user_id = #{search_user_id}
             </if>
             
             and order_total_price &gt;= #{fromPrice} and order_total_price &lt;= #{toPrice}
             and TO_CHAR(order_date, 'yyyyMMdd') &gt;= #{fromDate} and TO_CHAR(order_date, 'yyyyMMdd') &lt;= #{toDate}
             
             <if test="sortDsc=='true'">
             order by order_total_price DESC
             </if>
          )
          where rownum &lt;= #{pager.endRowNo}
      ) 
      where rnum &gt;= #{pager.startRowNo}
   </select>
   
   <select id="count" resultType="int">
      select count(*) 
      from orders 
      <if test="state == 7">
         where order_state != 0
      </if>
      <if test="state != 7">
         where order_state = #{state}
      </if>
      <if test="search_user_id != 'undefined'">
         and users_user_id = #{search_user_id}
      </if>
      and order_total_price &gt;= #{fromPrice} and order_total_price &lt;= #{toPrice}
      and TO_CHAR(order_date, 'yyyyMMdd') &gt;= #{fromDate} and TO_CHAR(order_date, 'yyyyMMdd') &lt;= #{toDate}
   </select>
   
   <select id="selectStateCountByState" resultType="int">
   		select count(*)
   		from orders
   		<if test="search_user_id == 'undefined'">where order_state = #{state}</if>
   		<if test="search_user_id != 'undefined'">where order_state = #{state} and users_user_id = #{search_user_id}</if>
   		and order_total_price &gt;= #{fromPrice} and order_total_price &lt;= #{toPrice}
   		and TO_CHAR(order_date, 'yyyyMMdd') &gt;= #{fromDate} and TO_CHAR(order_date, 'yyyyMMdd') &lt;= #{toDate}
   </select>

   <select id="selectByOrderId" parameterType="int" resultType="order">
   	select order_id
    		,order_receiver
    		,order_tel
    		,order_address
    		,order_detail_address
    		,order_msg
    		,users_user_id
    		,order_state
    		,order_date
    		,order_zipcode
    		,order_account_name
    		,order_account
    		,order_total_price
    from orders
    where order_id = #{order_id}
   </select>
   
   <select id="selectMainProductByOrderId" parameterType="int" resultType="String">
	   	select product_title
		from (select products_product_id
			  from orders, order_products
		      where #{order_id} = order_products.orders_order_id ) tmp, products
		where tmp.products_product_id = products.product_id and rownum=1
   </select>
	
	<select id="selectMonthPrice" resultType="monthlydata">
		select b.order_date as month,nvl(a.order_total_price,0) as month_total_price
		from
		    (select TO_CHAR(order_date,'yyyymm') as order_date ,sum(order_total_price) as order_total_price
		    from orders 
		    where order_date &gt;= to_date(concat(to_char(add_months(SYSDATE,-12),'yyyymm'),'01')) and order_date &lt;= sysdate and order_state!=0 AND order_state!=9
		    group by TO_CHAR(order_date,'yyyymm')
		    order by order_date) a
		        full join
		    (select level as order_date
		    from dual
		     where level &gt; TO_NUMBER(TO_CHAR(add_months(SYSDATE,-13),'YYYYmm')) and substr(level,5,2) &gt; '00' and substr(level,5,2) &lt;'13'
		     connect by level &lt;= to_number(to_char(sysdate, 'YYYYmm'))) b
		 ON a.order_date=b.order_date
		 order by b.order_date
	</select>
	
	<select id="selectMonthCount" resultType="monthlydata">
		select b.order_date as month ,nvl(a.order_count,0) as month_count
		from
		    (select TO_CHAR(order_date,'yyyymm') as order_date ,count(*) as order_count
	        from orders 
	        where order_date &gt;= to_date(concat(to_char(add_months(SYSDATE,-12),'yyyymm'),'01')) and order_date &lt;= sysdate and order_state!=0 AND order_state!=9
	        group by TO_CHAR(order_date,'yyyymm')
	        order by order_date) a
		            full join
		    (select level as order_date
	        from dual
	        where level &gt; TO_NUMBER(TO_CHAR(add_months(SYSDATE,-13),'YYYYmm')) and substr(level,5,2) &gt; '00' and substr(level,5,2) &lt;'13'
	        connect by level &lt;= to_number(to_char(sysdate, 'YYYYmm'))) b
		 ON a.order_date=b.order_date
		 order by b.order_date
	</select>
	
	<select id="selectCountryCount" resultType="ordercount">
		select product_country,sum(product_sale_count) as order_count
		from products
		group by product_country
	</select>

	<select id="selectTasteCount" resultType="ordercount">
		select product_taste,sum(product_sale_count) as order_count
		from products
		group by product_taste
	</select>
	
	<select id="selectOrderCount" resultType="int">
		select count(*)
		from orders
		where (order_state!=0 AND order_state!=9) AND to_char(order_date)=to_char(sysdate, 'yy/mm/dd')
	</select>
	
	<select id="selectDatePrice" parameterType="string" resultType="monthlydata">
		select b.o_date as order_date,nvl(order_total_price,0) as order_total_price
		from
		    (select TO_CHAR(order_date,'yyyy/mm/dd') as o_date ,sum(order_total_price) as order_total_price
		    from orders
		    where TO_CHAR(order_date,'yyyy/mm')=#{order_month} AND order_state!=0 AND order_state!=9
		    group by TO_CHAR(order_date,'yyyy/mm/dd')
		    order by TO_CHAR(order_date,'yyyy/mm/dd')) a
		        full join
		    (select to_char(to_date(concat(#{order_month},'/01'))+(level-1),'yyyy/mm/dd') AS o_date
		    from dual
		    connect by level &lt;= LAST_DAY(concat(#{order_month},'/01')) - to_date(concat(#{order_month},'/01'))+1) b
		ON a.o_date=b.o_date
		order by order_date
	</select>

	<select id="selectByDate" parameterType="string" resultType="order">
		select order_id, order_account_name, order_total_price
		from orders
		where to_char(order_date,'yyyy/mm/dd')=#{order_date}  AND order_state!=0 AND order_state!=9
	</select>
	
	<update id="changeState">
		update orders set 
        order_state = #{changeState}
        where order_id=#{order_id}
	</update>
	
	<select id="getProductCount" resultType="int">
		select count(*)
		from order_products
		where orders_order_id = #{order_id}
	</select>
	
	<update id="updateOrder" parameterType="order">
		update orders set
			order_receiver = #{order_receiver},
			order_tel = #{order_tel},
			order_zipcode = #{order_zipcode},
			order_address = #{order_address},
			order_detail_address = #{order_detail_address},
			<if test="order_msg != null" >
			order_msg = #{order_msg}
			</if>
		where order_id = #{order_id}
	</update>
</mapper>